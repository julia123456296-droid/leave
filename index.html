<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è¦–è¦ºå°èªªåŠ‡æœ¬ç·¨è¼¯å™¨ - å®Œæ•´ç‰ˆ</title>
    <style>
        :root {
            --bg-body: #0f172a; --panel-bg: #1e293b; --accent: #38bdf8;
            --border: #334155; --text-p: #94a3b8; --text-h: #f1f5f9;
            --main-path: #f43f5e; --side-path: #10b981;
        }
        * { box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        body { margin: 0; background: var(--bg-body); color: var(--text-h); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        #top-dashboard { height: 60px; background: #020617; border-bottom: 2px solid var(--accent); display: flex; align-items: center; padding: 0 20px; gap: 20px; z-index: 20; }
        .stat-group { display: flex; flex-direction: column; }
        .stat-val { font-size: 16px; font-weight: 800; color: var(--accent); }
        .stat-lbl { font-size: 9px; color: var(--text-p); text-transform: uppercase; }

        .layout-main { display: flex; flex: 1; overflow: hidden; }

        #sidebar { width: 320px; background: #111827; border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; }
        .nav-section { border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .nav-header { padding: 15px; background: #1e293b; font-size: 13px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; color: var(--accent); position: sticky; top: 0; z-index: 10; }
        
        .nav-card { background: #1e293b; border: 1px solid var(--border); padding: 12px; border-radius: 6px; margin: 8px 12px; font-size: 13px; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .nav-card.active { border-left: 5px solid var(--accent); background: #334155; }
        .reorder-btns { display: flex; flex-direction: column; gap: 2px; opacity: 0.3; }
        .nav-card:hover .reorder-btns { opacity: 1; }
        .reorder-btns button { background: #0f172a; color: white; border: 1px solid var(--border); border-radius: 3px; cursor: pointer; font-size: 10px; padding: 1px 4px; }

        #editor-pane { flex: 1; overflow-y: auto; padding: 40px; background: #0f172a; padding-bottom: 120px; }
        .editor-container { max-width: 1000px; margin: 0 auto; display: none; }
        .config-block { background: var(--panel-bg); border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 1px solid var(--border); }
        .block-title { font-size: 16px; font-weight: bold; color: var(--accent); margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        label { display: block; font-size: 11px; color: var(--text-p); margin-bottom: 8px; text-transform: uppercase; margin-top: 15px; }
        input, select, textarea { width: 100%; background: #0f172a; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; font-size: 14px; outline: none; }
        textarea { resize: vertical; min-height: 80px; }
        
        .grid-matrix { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .char-presence-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .char-chip { padding: 6px 15px; background: #0f172a; border: 1px solid var(--border); border-radius: 20px; font-size: 12px; cursor: pointer; }
        .char-chip.active { border-color: var(--accent); background: rgba(56, 189, 248, 0.1); color: var(--accent); }

        .block-nav { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .block-tab { padding: 8px 16px; background: #0f172a; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap; }
        .block-tab.active { background: var(--accent); color: #020617; font-weight: bold; }

        .script-row { display: flex; gap: 10px; margin-bottom: 12px; padding: 12px; background: #0f172a; border-radius: 8px; }
        .dialogue-text { flex: 1; height: 60px; }
        .choice-row { background: rgba(56, 189, 248, 0.05); border: 1px dashed var(--accent); display: flex; gap: 10px; padding: 15px; border-radius: 8px; margin-bottom: 12px; align-items: center; }
        
        .btn-group { display: flex; gap: 10px; margin-left: auto; }
        .btn-export { background: var(--side-path); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-backup { background: #475569; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .save-tag { font-size: 10px; color: var(--side-path); margin-left: 10px; }

        .editor-footer { position: fixed; bottom: 0; right: 0; width: calc(100% - 320px); background: #020617; border-top: 1px solid var(--border); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .btn-nav { background: #1e293b; color: white; border: 1px solid var(--border); padding: 10px 25px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

<div id="top-dashboard">
    <div class="stat-group"><span class="stat-lbl">äº‹ä»¶</span><span class="stat-val" id="node-count">0</span></div>
    <div class="stat-group"><span class="stat-lbl">è§’è‰²</span><span class="stat-val" id="char-count">0</span></div>
    <div id="auto-save-status" class="save-tag">å·²è‡ªå‹•å­˜æª”</div>
    <div class="btn-group">
        <button class="btn-backup" onclick="app.backupData()">ğŸ’¾ å‚™ä»½</button>
        <button class="btn-backup" onclick="app.restoreData()">ğŸ“‚ é‚„åŸ</button>
        <button class="btn-export" onclick="app.exportScript()">ğŸ“¤ å°å‡ºåŠ‡æœ¬</button>
    </div>
</div>

<div class="layout-main">
    <div id="sidebar">
        <div class="nav-section"><div class="nav-header">äººç‰©åº« <button onclick="app.add('chars')">+</button></div><div id="list-chars"></div></div>
        <div class="nav-section"><div class="nav-header">åœ°é»åº« <button onclick="app.add('locs')">+</button></div><div id="list-locs"></div></div>
        <div class="nav-section"><div class="nav-header">åŠ‡æƒ…æµ <button onclick="app.add('events')">+</button></div><div id="list-events"></div></div>
    </div>

    <div id="editor-pane">
        <div id="empty-state" style="text-align:center; margin-top:150px; color:var(--text-p)"><h2>æ­¡è¿ï¼è«‹é»æ“Šå·¦å´é€²è¡Œç·¨è¼¯</h2></div>

        <div id="editor-event" class="editor-container">
            <div class="config-block">
                <div class="block-title">æ ¸å¿ƒå±¬æ€§</div>
                <div class="grid-matrix">
                    <div><label>äº‹ä»¶æ¨™é¡Œ</label><input type="text" id="ev-title" oninput="app.updateActive('title', this.value)"></div>
                    <div><label>ç·šè·¯</label><select id="ev-route-sel" onchange="app.updateActive('route', this.value)"><option value="å…±é€šç·š">å…±é€šç·š</option><option value="å€‹äººç·š">å€‹äººç·š</option></select></div>
                    <div><label>æ—¥æœŸ</label><select id="ev-time-sel" onchange="app.updateActive('time', this.value)"><option value="">ç„¡</option><option value="é€±ä¸€">é€±ä¸€</option><option value="é€±äºŒ">é€±äºŒ</option><option value="é€±ä¸‰">é€±ä¸‰</option><option value="é€±å››">é€±å››</option><option value="é€±äº”">é€±äº”</option><option value="é€±å…­">é€±å…­</option><option value="é€±æ—¥">é€±æ—¥</option></select></div>
                </div>
                <div class="grid-matrix">
                    <div><label>åœ°é»</label><select id="ev-loc-sel" onchange="app.updateActive('loc', this.value)"></select></div>
                    <div><label>å‰ç½®äº‹ä»¶</label><select id="ev-prev-sel" onchange="app.updateActive('prev', this.value)"></select></div>
                    <div><label>æ€§è³ª</label><select id="ev-type-sel" onchange="app.updateActive('type', this.value)"><option value="æ™®é€šäº‹ä»¶">æ™®é€šäº‹ä»¶</option><option value="å¥½æ„Ÿäº‹ä»¶">å¥½æ„Ÿäº‹ä»¶</option><option value="çµå±€">çµå±€</option></select></div>
                </div>
            </div>
            <div class="config-block">
                <div class="block-title">æœ¬å ´ç™»å ´è§’è‰²</div>
                <div id="char-presence-list" class="char-presence-grid"></div>
            </div>
            <div class="config-block">
                <div class="block-title">åŠ‡æƒ…å°è©± <button class="btn-nav" style="padding:4px 10px; font-size:11px" onclick="app.addBlock()">+ æ–°åˆ†æ”¯å¡Š</button></div>
                <div id="block-tabs" class="block-nav"></div>
                <div id="script-list"></div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn-nav" style="flex:1" onclick="app.addLine('dia')">+ æ’å…¥å°è©±</button>
                    <button class="btn-nav" style="flex:1; border-color:var(--side-path); color:var(--side-path)" onclick="app.addLine('choice')">+ æ’å…¥é¸é …</button>
                </div>
            </div>
        </div>

        <div id="editor-char" class="editor-container">
            <div class="config-block">
                <div class="block-title">è§’è‰²è©³ç´°è¨­å®š</div>
                <label>è§’è‰²å§“å</label>
                <input type="text" id="char-name" oninput="app.updateActive('name', this.value)">
                
                <label>è§’è‰²ç°¡ä»‹ / æ€§æ ¼è¨­å®š</label>
                <textarea id="char-desc" placeholder="è¼¸å…¥è§’è‰²çš„åŸºæœ¬æ€§æ ¼ã€èƒŒæ™¯æ•…äº‹..." oninput="app.updateActive('desc', this.value)"></textarea>
                
                <label>å¤–å‹ / æœè£ç‰¹å¾µ</label>
                <textarea id="char-look" placeholder="ä¾‹å¦‚ï¼šç©¿è‘—æ ¡æœã€æˆ´çœ¼é¡ã€è—è‰²é ­é«®..." oninput="app.updateActive('look', this.value)"></textarea>
            </div>
        </div>

        <div id="editor-loc" class="editor-container">
            <div class="config-block">
                <div class="block-title">åœ°é»è©³ç´°è¨­å®š</div>
                <label>åœ°é»åç¨±</label>
                <input type="text" id="loc-name" oninput="app.updateActive('name', this.value)">
                
                <label>åœ°é»è©³ç´°æè¿°</label>
                <textarea id="loc-desc" placeholder="æè¿°é€™å€‹å ´æ™¯çš„æ°£æ°›ã€ç’°å¢ƒç‰©ä»¶..." oninput="app.updateActive('desc', this.value)"></textarea>
            </div>
        </div>
    </div>

    <div class="editor-footer" id="editor-nav" style="display:none">
        <button class="btn-nav" onclick="app.navigate(-1)">â† ä¸Šä¸€ç« </button>
        <div id="nav-info"></div>
        <button class="btn-nav" onclick="app.navigate(1)">ä¸‹ä¸€ç«  â†’</button>
    </div>
</div>

<script>
const app = {
    active: { type: null, id: null, blockIdx: 0 },
    db: {
        chars: { "c1": {name: "æ—ç™½", desc: "", look: ""}, "c2": {name: "ä¸»è§’", desc: "", look: ""} },
        locs: { "l1": {name: "è¾¦å…¬å®¤", desc: ""} },
        events: [
            { id: "e1", title: "åºç« ", route: "å…±é€šç·š", type: "æ™®é€šäº‹ä»¶", time: "é€±ä¸€", loc: "è¾¦å…¬å®¤", prev: "", presentChars: ["c1", "c2"], blocks: [{ name: "é–‹å§‹", lines: [{type: "dia", w: "æ—ç™½", t: "æ•…äº‹ç”±æ­¤å±•é–‹..."}] }] }
        ]
    },

    init() { this.loadFromStorage(); this.renderAllLists(); },

    saveToStorage() {
        localStorage.setItem('vn_editor_data_v2', JSON.stringify(this.db));
        document.getElementById('auto-save-status').innerText = "å·²è‡ªå‹•å­˜æª” " + new Date().toLocaleTimeString();
    },
    loadFromStorage() {
        const saved = localStorage.getItem('vn_editor_data_v2');
        if (saved) this.db = JSON.parse(saved);
    },

    backupData() {
        const blob = new Blob([JSON.stringify(this.db, null, 2)], { type: "application/json" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `åŠ‡æœ¬å‚™ä»½_${new Date().toLocaleDateString()}.json`;
        link.click();
    },
    restoreData() {
        const input = document.createElement('input'); input.type = 'file';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = event => {
                if (confirm("ç¢ºå®šé‚„åŸï¼Ÿé€™æœƒè¦†è“‹ç›®å‰çš„æ•¸æ“šã€‚")) {
                    this.db = JSON.parse(event.target.result);
                    this.saveToStorage(); location.reload();
                }
            };
            reader.readAsText(e.target.files[0]);
        };
        input.click();
    },

    add(type) {
        const id = type[0] + Date.now();
        if(type === 'chars') this.db.chars[id] = {name: "æ–°è§’è‰²", desc: "", look: ""};
        else if(type === 'locs') this.db.locs[id] = {name: "æ–°åœ°é»", desc: ""};
        else this.db.events.push({ id, title: "æ–°äº‹ä»¶", route: "å…±é€šç·š", type: "æ™®é€šäº‹ä»¶", time: "", loc: "", prev: "", presentChars: ["c1"], blocks: [{name: "é–‹å§‹", lines: []}]});
        this.saveToStorage(); this.renderAllLists(); this.open(type, id);
    },
    open(type, id) {
        this.active = { type, id, blockIdx: 0 };
        document.getElementById('empty-state').style.display = 'none';
        document.querySelectorAll('.editor-container').forEach(el => el.style.display = 'none');
        document.getElementById('editor-nav').style.display = (type === 'events') ? 'flex' : 'none';

        if(type === 'events') {
            const data = this.db.events.find(e => e.id === id);
            document.getElementById('editor-event').style.display = 'block';
            document.getElementById('ev-title').value = data.title;
            document.getElementById('ev-route-sel').value = data.route;
            document.getElementById('ev-time-sel').value = data.time;
            document.getElementById('ev-type-sel').value = data.type;
            document.getElementById('ev-loc-sel').innerHTML = Object.values(this.db.locs).map(l => `<option value="${l.name}">${l.name}</option>`).join('');
            document.getElementById('ev-loc-sel').value = data.loc;
            const eventOpts = '<option value="">(ç„¡)</option>' + this.db.events.map(e => `<option value="${e.title}">${e.title}</option>`).join('');
            document.getElementById('ev-prev-sel').innerHTML = eventOpts;
            document.getElementById('ev-prev-sel').value = data.prev;
            this.renderPresence(); this.renderBlocks();
            document.getElementById('nav-info').innerText = data.title;
        } else if(type === 'chars') {
            document.getElementById('editor-char').style.display = 'block';
            document.getElementById('char-name').value = this.db.chars[id].name;
            document.getElementById('char-desc').value = this.db.chars[id].desc || "";
            document.getElementById('char-look').value = this.db.chars[id].look || "";
        } else if(type === 'locs') {
            document.getElementById('editor-loc').style.display = 'block';
            document.getElementById('loc-name').value = this.db.locs[id].name;
            document.getElementById('loc-desc').value = this.db.locs[id].desc || "";
        }
        this.renderAllLists();
    },
    updateActive(f, v) { 
        if(this.active.type === 'events') this.db.events.find(e => e.id === this.active.id)[f] = v;
        else this.db[this.active.type][this.active.id][f] = v;
        this.saveToStorage(); this.renderAllLists(); 
    },
    moveEvent(id, dir, e) {
        e.stopPropagation();
        const idx = this.db.events.findIndex(ev => ev.id === id);
        if (dir === -1 && idx > 0) [this.db.events[idx], this.db.events[idx - 1]] = [this.db.events[idx - 1], this.db.events[idx]];
        else if (dir === 1 && idx < this.db.events.length - 1) [this.db.events[idx], this.db.events[idx + 1]] = [this.db.events[idx + 1], this.db.events[idx]];
        this.saveToStorage(); this.renderAllLists();
    },
    renderPresence() {
        const ev = this.db.events.find(e => e.id === this.active.id);
        document.getElementById('char-presence-list').innerHTML = Object.entries(this.db.chars).map(([cid, c]) => `
            <div class="char-chip ${ev.presentChars.includes(cid) ? 'active' : ''}" onclick="app.togglePresence('${cid}')">${c.name}</div>
        `).join('');
    },
    togglePresence(cid) {
        const ev = this.db.events.find(e => e.id === this.active.id);
        const idx = ev.presentChars.indexOf(cid);
        if(idx > -1) { if(this.db.chars[cid].name !== "æ—ç™½") ev.presentChars.splice(idx, 1); }
        else ev.presentChars.push(cid);
        this.saveToStorage(); this.renderPresence(); this.renderLines();
    },
    renderBlocks() {
        const ev = this.db.events.find(e => e.id === this.active.id);
        document.getElementById('block-tabs').innerHTML = ev.blocks.map((b, i) => `
            <div class="block-tab ${this.active.blockIdx === i ? 'active' : ''}" onclick="app.switchBlock(${i})">${i===0?'ğŸš© ':''}${b.name}</div>
        `).join('');
        this.renderLines();
    },
    switchBlock(i) { this.active.blockIdx = i; this.renderBlocks(); },
    addBlock() { 
        const name = prompt("åˆ†æ”¯å¡Šåç¨±ï¼Ÿ"); 
        if(name){ 
            const ev = this.db.events.find(e => e.id === this.active.id);
            ev.blocks.push({name, lines: []}); 
            this.active.blockIdx = ev.blocks.length-1; 
            this.saveToStorage(); this.renderBlocks(); 
        }
    },
    renderLines() {
        const list = document.getElementById('script-list'); list.innerHTML = '';
        const ev = this.db.events.find(e => e.id === this.active.id);
        const block = ev.blocks[this.active.blockIdx];
        const available = ev.presentChars.map(cid => this.db.chars[cid]);
        block.lines.forEach((line, i) => {
            const row = document.createElement('div');
            if(line.type === 'dia') {
                row.className = 'script-row';
                let opts = available.map(c => `<option value="${c.name}" ${line.w===c.name?'selected':''}>${c.name}</option>`).join('');
                row.innerHTML = `<select style="width:100px" onchange="app.updateLine(${i}, 'w', this.value)">${opts}</select>
                    <textarea class="dialogue-text" oninput="app.updateLine(${i}, 't', this.value)">${line.t}</textarea>
                    <button onclick="app.delLine(${i})" style="color:var(--main-path); border:none; background:none; cursor:pointer">Ã—</button>`;
            } else {
                row.className = 'choice-row';
                let targetOpts = ev.blocks.map((b, bi) => `<option value="${bi}" ${line.target==bi?'selected':''}>è·³è½‰: ${b.name}</option>`).join('');
                row.innerHTML = `<div style="color:var(--accent); font-weight:bold; font-size:11px; width:40px;">é¸é …</div>
                    <input type="text" value="${line.t}" oninput="app.updateLine(${i}, 't', this.value)">
                    <select onchange="app.updateLine(${i}, 'target', this.value)">${targetOpts}</select>
                    <button onclick="app.delLine(${i})" style="color:var(--main-path); border:none; background:none; cursor:pointer">Ã—</button>`;
            }
            list.appendChild(row);
        });
    },
    addLine(type) {
        const ev = this.db.events.find(e => e.id === this.active.id);
        const block = ev.blocks[this.active.blockIdx];
        if(type === 'dia') block.lines.push({type: 'dia', w: this.db.chars[ev.presentChars[0]]?.name || "æ—ç™½", t: ""});
        else block.lines.push({type: 'choice', t: "æ–°çš„é¸é …", target: 0});
        this.saveToStorage(); this.renderLines();
    },
    updateLine(i, f, v) { this.db.events.find(e => e.id === this.active.id).blocks[this.active.blockIdx].lines[i][f] = v; this.saveToStorage(); },
    delLine(i) { this.db.events.find(e => e.id === this.active.id).blocks[this.active.blockIdx].lines.splice(i,1); this.saveToStorage(); this.renderLines(); },
    renderAllLists() {
        document.getElementById('list-chars').innerHTML = Object.entries(this.db.chars).map(([id, item]) => `<div class="nav-card ${this.active.id===id?'active':''}" onclick="app.open('chars','${id}')">${item.name}</div>`).join('');
        document.getElementById('list-locs').innerHTML = Object.entries(this.db.locs).map(([id, item]) => `<div class="nav-card ${this.active.id===id?'active':''}" onclick="app.open('locs','${id}')">${item.name}</div>`).join('');
        document.getElementById('list-events').innerHTML = this.db.events.map((item, idx) => `
            <div class="nav-card ${this.active.id === item.id ? 'active' : ''}" onclick="app.open('events', '${item.id}')">
                <div style="flex:1"><b>${item.title}</b></div>
                <div class="reorder-btns"><button onclick="app.moveEvent('${item.id}', -1, event)">â–²</button><button onclick="app.moveEvent('${item.id}', 1, event)">â–¼</button></div>
            </div>`).join('');
        document.getElementById('node-count').innerText = this.db.events.length;
        document.getElementById('char-count').innerText = Object.keys(this.db.chars).length;
    },
    navigate(dir) {
        const idx = this.db.events.findIndex(e => e.id === this.active.id);
        const newIdx = idx + dir;
        if(newIdx >= 0 && newIdx < this.db.events.length) this.open('events', this.db.events[newIdx].id);
    },
    exportScript() {
        let html = `<html><head><title>åŠ‡æœ¬å°å‡º</title><style>body { font-family: sans-serif; max-width: 800px; margin: 40px auto; line-height: 1.6; color: #333; } .meta-section { background:#f8fafc; padding:20px; border-radius:10px; margin-bottom:40px; } .event-box { border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 40px; page-break-after: always; } .dia-line { margin-bottom: 10px; display: flex; } .name { width: 100px; font-weight: bold; flex-shrink: 0; } .choice-box { background: #e0f2fe; padding: 10px; border-radius: 5px; margin: 10px 0; border: 1px dashed #38bdf8; }</style></head><body>`;
        
        // å°å‡ºè§’è‰²èˆ‡åœ°é»æ¸…å–®
        html += `<div class="meta-section"><h1>è¨­å®šé›†</h1><h3>ç™»å ´è§’è‰²</h3><ul>`;
        Object.values(this.db.chars).forEach(c => html += `<li><b>${c.name}</b>: ${c.desc || 'ç„¡æè¿°'} (ç‰¹å¾µ: ${c.look || 'ç„¡'})</li>`);
        html += `</ul><h3>å ´æ™¯åœ°é»</h3><ul>`;
        Object.values(this.db.locs).forEach(l => html += `<li><b>${l.name}</b>: ${l.desc || 'ç„¡æè¿°'}</li>`);
        html += `</ul></div>`;

        this.db.events.forEach(ev => {
            html += `<div class="event-box"><h1>${ev.title}</h1><p>åœ°é»ï¼š${ev.loc} | æ™‚é–“ï¼š${ev.time}</p>`;
            ev.blocks.forEach(block => {
                html += `<div style="background:#eee;padding:5px;margin:10px 0">å€å¡Šï¼š${block.name}</div>`;
                block.lines.forEach(line => {
                    if(line.type === 'dia') html += `<div class="dia-line"><div class="name">${line.w}</div><div>${line.t.replace(/\n/g, '<br>')}</div></div>`;
                    else html += `<div class="choice-box">é¸é …ï¼š${line.t} â” è·³è½‰è‡³ ${ev.blocks[line.target]?.name}</div>`;
                });
            });
            html += `</div>`;
        });
        const win = window.open('', '_blank'); win.document.write(html); win.document.close();
    }
};
app.init();
</script>
</body>
</html>